<!DOCTYPE html>
<html>

<head>
    <title>Upload Image</title>
</head>

<body>
    <h1>Upload Image</h1>
    <form action="/upload" method="post" enctype="multipart/form-data" novalidate>
        <input type="password" name="password" placeholder="Enter password" required>
        <input type="file" name="image" accept="image/*" required>
        <input type="submit" value="Upload">
    </form>
    <button onclick="deleteSelectedImages()">Delete Selected Images</button>
    <div id="image-list"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            listImages(); // Call to list images on page load
        });

        function listImages() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/images', true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var images = JSON.parse(xhr.responseText);
                    var imageList = document.getElementById('image-list');
                    imageList.innerHTML = '';

                    images.forEach((image) => {
                        var label = document.createElement('label');
                        var checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'selectedImages';
                        checkbox.value = image.url;

                        var img = document.createElement('img');
                        img.src = image.url;
                        img.alt = image.name;
                        img.style.width = '100px'; // Set image size

                        label.appendChild(checkbox);
                        label.appendChild(img);
                        imageList.appendChild(label);
                    });
                } else {
                    console.error('Failed to retrieve images');
                }
            };
            xhr.send();
        }

        function uploadFile(file) {
            var formData = new FormData();
            formData.append("image", file);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Upload successful');
                    listImages(); // Refresh the list after uploading
                } else {
                    console.log('Upload failed');
                }
            };
            xhr.send(formData);
            xhr.send(file);
        }

        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();
            var file = document.querySelector('input[type="file"]').files[0];
            console.log(file); // Log the selected file
            if (file) {
                console.log('Uploading file...'); // Log before uploading
                uploadFile(file);
            }
        });

        function deleteSelectedImages() {
            var selectedImages = Array.from(document.querySelectorAll('input[name="selectedImages"]:checked')).map(input => input.value);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/delete-images', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Images deleted successfully');
                    listImages(); // Refresh the list after deleting
                } else {
                    console.error('Failed to delete images');
                }
            };
            xhr.send(JSON.stringify({ selectedImages: selectedImages }));
        }
    </script>
</body>

</html>